<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Draw - ÊäΩÁ±§Á≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ÂºïÂÖ•ÂΩ©Â∏∂ÁâπÊïàÂ∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- ÂºïÂÖ•ÂúñÊ®ôÂ∫´ (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #8B0000; 
            /* È†êË®≠ËÉåÊôØÂúñ */
            background-image: url('image_720f43.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            margin: 0;
            overflow: hidden;
            transition: background-image 0.5s ease;
        }

        .glass-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 2rem;
            width: 90%;
            max-width: 900px;
            height: 85vh;
            color: white;
            display: flex;
            flex-direction: row;
            gap: 2rem;
            position: relative;
        }

        .left-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .right-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .glass-container {
                flex-direction: column;
                height: 90vh;
                padding: 1.5rem;
                overflow-y: auto;
            }
            .right-panel {
                width: 100%;
                flex: 1;
                margin-top: 1rem;
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            .result-display {
                font-size: 6rem !important;
                min-height: 150px !important;
            }
        }

        .settings-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }

        .result-display {
            font-size: 10rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            margin: 1rem 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .draw-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: #2d0a0a;
            font-weight: bold;
            padding: 1.2rem 3rem;
            border-radius: 50px;
            font-size: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 300px;
        }
        .draw-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        .draw-btn:active:not(:disabled) { transform: scale(0.95); }
        .draw-btn:disabled { cursor: not-allowed; filter: grayscale(0.5); }

        .history-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 5px;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 5px;
        }
        .history-list::-webkit-scrollbar { width: 6px; }
        .history-list::-webkit-scrollbar-thumb { background: rgba(255, 215, 0, 0.3); border-radius: 3px; }

        .history-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            border-left: 3px solid #ffd700;
        }
        .history-item .index { opacity: 0.6; font-size: 0.8rem; }
        .history-item .number { font-size: 1.2rem; font-weight: bold; color: #ffd700; }

        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: rgba(40, 40, 40, 0.95);
            border: 1px solid #d4af37;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            color: white;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .custom-input, .custom-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            width: 100%;
            outline: none;
            text-align: center;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .custom-select { text-align: left; cursor: pointer; }
        .custom-select option { background: #333; color: white; }
        .custom-input:focus, .custom-select:focus { border-color: #ffd700; }
        
        /* Ê™îÊ°à‰∏äÂÇ≥ÊåâÈàïÊ®£Âºè */
        .file-upload-wrapper {
            position: relative;
            margin-bottom: 1rem;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload-wrapper:hover { border-color: #ffd700; background: rgba(255, 255, 255, 0.05); }
        .file-upload-input {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        .save-btn {
            background: #d4af37; color: #2d0a0a; border: none;
            padding: 0.8rem 2rem; border-radius: 8px; font-weight: bold;
            cursor: pointer; width: 100%; font-size: 1rem; margin-top: 1rem;
        }
        .save-btn:hover { background: #c5a028; }

        .checkbox-wrapper {
            display: flex; align-items: center; justify-content: center;
            gap: 10px; margin: 1rem 0; cursor: pointer;
        }
        .custom-checkbox { width: 20px; height: 20px; accent-color: #d4af37; }

        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; border-radius: 8px; background: rgba(220, 38, 38, 0.9);
            color: white; display: none; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .reset-link {
            font-size: 0.8rem; color: rgba(255,255,255,0.6);
            text-decoration: underline; cursor: pointer; border: none; background: none;
        }
        .reset-link:hover { color: white; }
        
        .section-label {
            text-align: left; font-size: 0.8rem; opacity: 0.7; margin-bottom: 4px; display: block;
        }
    </style>
</head>
<body>

    <div id="messageBox" class="message-box"></div>

    <!-- Ë®≠ÂÆöÂΩàÂá∫Ë¶ñÁ™ó -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-[#ffd700]" data-i18n="settingsTitle">Ë®≠ÂÆö</h2>
            
            <!-- Ë™ûË®ÄË®≠ÂÆö -->
            <label class="section-label" data-i18n="language">Ë™ûË®Ä / Language</label>
            <select id="langSelect" class="custom-select" onchange="changeLanguage()">
                <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                <option value="en">English</option>
            </select>

            <div class="my-4 border-t border-white/10"></div>

            <!-- ËÉåÊôØË®≠ÂÆö -->
            <label class="section-label" data-i18n="bgImage">ËÉåÊôØÂúñÁâá</label>
            <div class="file-upload-wrapper">
                <span class="text-sm opacity-80" data-i18n="clickToUpload">ÈªûÊìä‰∏äÂÇ≥ËÉåÊôØÂúñÁâá</span>
                <input type="file" id="bgInput" class="file-upload-input" accept="image/*" onchange="handleBgUpload(this)">
            </div>

            <div class="my-4 border-t border-white/10"></div>

            <!-- Êï∏Â≠óÁØÑÂúç -->
            <label class="section-label" data-i18n="numRange">Êï∏Â≠óÁØÑÂúç</label>
            <div class="flex gap-4 mb-2">
                <div class="w-1/2">
                    <label class="text-xs opacity-60 block mb-1" data-i18n="min">ÊúÄÂ∞èÂÄº</label>
                    <input type="number" id="minRange" class="custom-input" value="1">
                </div>
                <div class="w-1/2">
                    <label class="text-xs opacity-60 block mb-1" data-i18n="max">ÊúÄÂ§ßÂÄº</label>
                    <input type="number" id="maxRange" class="custom-input" value="40">
                </div>
            </div>

            <label class="checkbox-wrapper">
                <input type="checkbox" id="noRepeat" class="custom-checkbox">
                <span data-i18n="noRepeatMode">ÈñãÂïü„Äå‰∏çÈáçË§áÊäΩÁ±§„ÄçÊ®°Âºè</span>
            </label>

            <button onclick="closeSettings()" class="save-btn" data-i18n="saveBtn">ÂÑ≤Â≠ò‰∏¶ÈóúÈñâ</button>
        </div>
    </div>

    <!-- ‰∏ªÁïåÈù¢ -->
    <div class="glass-container">
        
        <div class="left-panel">
            <button onclick="openSettings()" class="settings-btn" title="Settings">
                <i data-lucide="settings"></i>
            </button>

            <!-- Ê®ôÈ°åÂçÄÂüüÔºöÂ∑≤ÁßªÈô§„ÄåÈ¶¨‰∏äÂ¶ÇÊÑè„Äç -->
            <h1 class="text-4xl font-bold mb-2 text-shadow-sm mt-4" data-i18n="appTitle">ÊäΩÁ±§Á≥ªÁµ±</h1>
            <p class="text-sm opacity-90 mb-4" data-i18n="appSubtitle">Âπ∏ÈÅãÈö®Ê©üÁî¢ÁîüÂô®</p>

            <div id="result" class="result-display">?</div>

            <button onclick="startDraw()" id="drawBtn" class="draw-btn" data-i18n="startBtn">
                ÈñãÂßãÊäΩÁ±§
            </button>
            
            <p class="mt-8 text-xs opacity-60" data-i18n="footerTip">ÈªûÊìäÂ∑¶‰∏äËßíË®≠ÂÆöÂúñÁ§∫ÂèØË™øÊï¥ÂäüËÉΩ</p>
        </div>

        <div class="right-panel">
            <div class="history-title">
                <span data-i18n="historyTitle">Ê≠∑Âè≤Á¥ÄÈåÑ</span>
                <button onclick="resetHistory()" class="reset-link" data-i18n="clearBtn">Ê∏ÖÈô§</button>
            </div>
            <div id="historyList" class="history-list">
                <div class="text-center text-xs opacity-40 mt-10" data-i18n="noHistory">Â∞öÁÑ°Á¥ÄÈåÑ</div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // Â§öË™ûË®ÄÂ≠óÂÖ∏
        const translations = {
            'zh-TW': {
                appTitle: "ÊäΩÁ±§Á≥ªÁµ±",
                appSubtitle: "Âπ∏ÈÅãÈö®Ê©üÁî¢ÁîüÂô®",
                settingsTitle: "Ë®≠ÂÆö",
                language: "Ë™ûË®Ä",
                bgImage: "Êõ¥ÊèõËÉåÊôØ",
                clickToUpload: "ÈªûÊìä‰∏äÂÇ≥ËÉåÊôØÂúñÁâá",
                numRange: "Êï∏Â≠óÁØÑÂúç",
                min: "ÊúÄÂ∞èÂÄº",
                max: "ÊúÄÂ§ßÂÄº",
                noRepeatMode: "ÈñãÂïü„Äå‰∏çÈáçË§áÊäΩÁ±§„ÄçÊ®°Âºè",
                saveBtn: "ÂÑ≤Â≠ò‰∏¶ÈóúÈñâ",
                startBtn: "ÈñãÂßãÊäΩÁ±§",
                drawing: "ÊäΩÁ±§‰∏≠...",
                drawAgain: "ÂÜçÊ¨°ÊäΩÁ±§",
                historyTitle: "Ê≠∑Âè≤Á¥ÄÈåÑ",
                clearBtn: "Ê∏ÖÈô§",
                noHistory: "Â∞öÁÑ°Á¥ÄÈåÑ",
                drawIndex: "Á¨¨ {n} ÊäΩ",
                footerTip: "ÈªûÊìäÂ∑¶‰∏äËßíË®≠ÂÆöÂúñÁ§∫ÂèØË™øÊï¥ÂäüËÉΩ",
                msgInvalid: "Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊï∏Â≠óÔºÅ",
                msgMinMax: "ÊúÄÂ∞èÂÄºÂøÖÈ†àÂ∞èÊñºÊúÄÂ§ßÂÄºÔºÅ",
                msgReset: "Ë®≠ÂÆöÂ∑≤ËÆäÊõ¥ÔºåÊ≠∑Âè≤Á¥ÄÈåÑÂ∑≤ÈáçÁΩÆ",
                msgAllDrawn: "üéâ ÊâÄÊúâÊï∏Â≠óÈÉΩÂ∑≤Á∂ìÊäΩÂÆåÂõâÔºÅ"
            },
            'zh-CN': {
                appTitle: "ÊäΩÁ≠æÁ≥ªÁªü",
                appSubtitle: "Âπ∏ËøêÈöèÊú∫ÁîüÊàêÂô®",
                settingsTitle: "ËÆæÁΩÆ",
                language: "ËØ≠Ë®Ä",
                bgImage: "Êõ¥Êç¢ËÉåÊôØ",
                clickToUpload: "ÁÇπÂáª‰∏ä‰º†ËÉåÊôØÂõæÁâá",
                numRange: "Êï∞Â≠óËåÉÂõ¥",
                min: "ÊúÄÂ∞èÂÄº",
                max: "ÊúÄÂ§ßÂÄº",
                noRepeatMode: "ÂºÄÂêØ‚Äú‰∏çÈáçÂ§çÊäΩÁ≠æ‚ÄùÊ®°Âºè",
                saveBtn: "‰øùÂ≠òÂπ∂ÂÖ≥Èó≠",
                startBtn: "ÂºÄÂßãÊäΩÁ≠æ",
                drawing: "ÊäΩÁ≠æ‰∏≠...",
                drawAgain: "ÂÜçÊ¨°ÊäΩÁ≠æ",
                historyTitle: "ÂéÜÂè≤ËÆ∞ÂΩï",
                clearBtn: "Ê∏ÖÈô§",
                noHistory: "ÊöÇÊó†ËÆ∞ÂΩï",
                drawIndex: "Á¨¨ {n} ÊäΩ",
                footerTip: "ÁÇπÂáªÂ∑¶‰∏äËßíËÆæÁΩÆÂõæÊ†áÂèØË∞ÉÊï¥ÂäüËÉΩ",
                msgInvalid: "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠óÔºÅ",
                msgMinMax: "ÊúÄÂ∞èÂÄºÂøÖÈ°ªÂ∞è‰∫éÊúÄÂ§ßÂÄºÔºÅ",
                msgReset: "ËÆæÁΩÆÂ∑≤ÂèòÊõ¥ÔºåÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤ÈáçÁΩÆ",
                msgAllDrawn: "üéâ ÊâÄÊúâÊï∞Â≠óÈÉΩÂ∑≤ÁªèÊäΩÂÆåÂï¶ÔºÅ"
            },
            'en': {
                appTitle: "Lucky Draw",
                appSubtitle: "Random Number Generator",
                settingsTitle: "Settings",
                language: "Language",
                bgImage: "Background Image",
                clickToUpload: "Click to upload image",
                numRange: "Number Range",
                min: "Min Value",
                max: "Max Value",
                noRepeatMode: "No Repeat Mode",
                saveBtn: "Save & Close",
                startBtn: "Start",
                drawing: "Drawing...",
                drawAgain: "Draw Again",
                historyTitle: "History",
                clearBtn: "Clear",
                noHistory: "No History",
                drawIndex: "Draw #{n}",
                footerTip: "Click top-left icon for settings",
                msgInvalid: "Please input valid numbers!",
                msgMinMax: "Min must be less than Max!",
                msgReset: "Settings changed, history reset.",
                msgAllDrawn: "üéâ All numbers have been drawn!"
            }
        };

        let isDrawing = false;
        let drawnHistory = [];
        let currentSettings = { min: 1, max: 40, noRepeat: false, lang: 'zh-TW' };

        // È†ÅÈù¢ËºâÂÖ•
        window.addEventListener('load', loadData);

        function loadData() {
            const savedSettings = localStorage.getItem('lottery_settings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    // Âêà‰ΩµË®≠ÂÆöÔºåÁ¢∫‰øùÊñ∞Ê¨Ñ‰ΩçÂ≠òÂú®
                    currentSettings = { ...currentSettings, ...parsed };
                } catch (e) { console.error(e); }
            }

            // ÊáâÁî®Ë®≠ÂÆöÂà∞ UI
            document.getElementById('minRange').value = currentSettings.min;
            document.getElementById('maxRange').value = currentSettings.max;
            document.getElementById('noRepeat').checked = currentSettings.noRepeat;
            document.getElementById('langSelect').value = currentSettings.lang || 'zh-TW';

            // ÊáâÁî®Ë™ûË®ÄÊñáÂ≠ó
            applyLanguage(currentSettings.lang);

            // ËºâÂÖ•Ê≠∑Âè≤
            const savedHistory = localStorage.getItem('lottery_history');
            if (savedHistory) {
                try {
                    drawnHistory = JSON.parse(savedHistory);
                    if (drawnHistory.length > 0) {
                        document.getElementById('result').textContent = drawnHistory[drawnHistory.length - 1];
                        document.getElementById('drawBtn').textContent = translations[currentSettings.lang].drawAgain;
                        renderHistory();
                    }
                } catch (e) { console.error(e); }
            }
        }

        // --- Ë™ûË®ÄÂäüËÉΩ ---
        function changeLanguage() {
            const lang = document.getElementById('langSelect').value;
            applyLanguage(lang);
        }

        function applyLanguage(lang) {
            if (!translations[lang]) lang = 'zh-TW';
            const t = translations[lang];

            // Êõ¥Êñ∞ÊâÄÊúâÂ∏∂ data-i18n ÁöÑÂÖÉÁ¥†
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖãÊñáÂ≠ó (Â¶ÇÊûúÂú®ÊäΩÁ±§‰∏≠ÊàñÂ∑≤ÊäΩÂÆå)
            const btn = document.getElementById('drawBtn');
            if (!isDrawing) {
                btn.textContent = drawnHistory.length > 0 ? t.drawAgain : t.startBtn;
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìÊ≠∑Âè≤ÂàóË°®‰ª•Êõ¥Êñ∞ "Á¨¨ N ÊäΩ" ÊñáÂ≠ó
            renderHistory();
        }

        // --- ËÉåÊôØÂäüËÉΩ ---
        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.body.style.backgroundImage = `url('${e.target.result}')`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Ë®≠ÂÆöË¶ñÁ™ó ---
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            const min = parseInt(document.getElementById('minRange').value);
            const max = parseInt(document.getElementById('maxRange').value);
            const noRepeat = document.getElementById('noRepeat').checked;
            const lang = document.getElementById('langSelect').value;

            const t = translations[lang]; // ÂèñÂæóÁï∂ÂâçË™ûË®ÄÁöÑÈåØË™§Ë®äÊÅØ

            if (isNaN(min) || isNaN(max)) {
                showMessage(t.msgInvalid);
                return;
            }
            if (min >= max) {
                showMessage(t.msgMinMax);
                return;
            }

            // Ê™¢Êü•ÊòØÂê¶Êõ¥Âãï‰∫ÜË®≠ÂÆö
            if (min !== currentSettings.min || max !== currentSettings.max || noRepeat !== currentSettings.noRepeat) {
                if (drawnHistory.length > 0) {
                     resetHistory();
                     showMessage(t.msgReset);
                }
            }

            currentSettings = { min, max, noRepeat, lang };
            localStorage.setItem('lottery_settings', JSON.stringify(currentSettings));
            
            // Á¢∫‰øùÈóúÈñâÊôÇË™ûË®ÄË®≠ÂÆöË¢´ÊáâÁî® (Âç≥‰ΩøÊ≤íÊåâÂÑ≤Â≠òÔºåÂè™Ë¶ÅÊîπ‰∫ÜÈÅ∏ÂñÆ)
            applyLanguage(lang);

            document.getElementById('settingsModal').classList.remove('active');
        }

        // --- ÊäΩÁ±§ËàáÊ≠∑Âè≤ ---
        function showMessage(msg) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        function resetHistory() {
            drawnHistory = [];
            localStorage.removeItem('lottery_history');
            document.getElementById('result').textContent = '?';
            const t = translations[currentSettings.lang];
            document.getElementById('drawBtn').textContent = t.startBtn;
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const t = translations[currentSettings.lang];
            
            if (drawnHistory.length === 0) {
                list.innerHTML = `<div class="text-center text-xs opacity-40 mt-10" data-i18n="noHistory">${t.noHistory}</div>`;
                return;
            }

            list.innerHTML = '';
            drawnHistory.forEach((num, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                // ÊõøÊèõÊñáÂ≠ó‰∏≠ÁöÑËÆäÊï∏ {n}
                const indexText = t.drawIndex.replace('{n}', index + 1);
                item.innerHTML = `
                    <span class="index">${indexText}</span>
                    <span class="number">${num}</span>
                `;
                if(list.firstChild) list.insertBefore(item, list.firstChild);
                else list.appendChild(item);
            });
        }

        // --- Ê†∏ÂøÉÈÇèËºØ ---
        function startDraw() {
            if (isDrawing) return;

            const { min, max, noRepeat, lang } = currentSettings;
            const t = translations[lang];
            const resultEl = document.getElementById('result');
            const btn = document.getElementById('drawBtn');

            // Ê™¢Êü•ÊòØÂê¶ÊäΩÂÆå
            if (noRepeat && drawnHistory.length >= (max - min + 1)) {
                showMessage(t.msgAllDrawn);
                fireConfetti();
                return;
            }

            isDrawing = true;
            btn.disabled = true;
            btn.style.opacity = "0.7";
            btn.textContent = t.drawing;
            
            // --- ‰øÆÊîπÔºöÂØ¶ÁèæÊ∏õÈÄüËàáÂª∂Èï∑ÊôÇÈñì ---
            
            let speed = 50;       // ÂàùÂßãÈÄüÂ∫¶ (ÊØ´Áßí/Ê¨°)
            let totalTime = 0;    // Á¥ØË®àÊôÇÈñì
            const fastPhaseDuration = 2500; // È´òÈÄüË∑≥ÂãïÈöéÊÆµÁ∂≠ÊåÅ 2.5 Áßí (Â¢ûÂä†ÊôÇÈñì)
            
            // ‰ΩøÁî®ÈÅûËø¥ setTimeout Êõø‰ª£ setInterval ‰ª•ÂØ¶ÁèæËÆäÈÄü
            const runAnimation = () => {
                // 1. È°ØÁ§∫Èö®Ê©üÊï∏Â≠ó (Ë¶ñË¶∫ÊïàÊûú)
                const tempNum = Math.floor(Math.random() * (max - min + 1)) + min;
                resultEl.textContent = tempNum;
                
                // 2. Ë®àÁÆóÁ¥ØË®àÊôÇÈñì
                totalTime += speed;

                // 3. ÈÄüÂ∫¶ÊéßÂà∂ÈÇèËºØ
                if (totalTime > fastPhaseDuration) {
                    // Ë∂ÖÈÅéÈ´òÈÄüÈöéÊÆµÂæåÔºåÈñãÂßãÊ∏õÈÄü (ÊØèÊ¨°ÈñìÈöîÂ¢ûÂä† 15%)
                    speed = Math.floor(speed * 1.15);
                }

                // 4. Âà§Êñ∑ÊòØÂê¶ÂÅúÊ≠¢ (Áï∂ÈÄüÂ∫¶ÊÖ¢Âà∞Á¥Ñ 600ms Ë∑≥‰∏ÄÊ¨°ÊôÇÂÅúÊ≠¢)
                if (speed >= 600) {
                    finishDraw(min, max, noRepeat, t, resultEl, btn);
                } else {
                    setTimeout(runAnimation, speed);
                }
            };

            runAnimation();
        }

        // ÊäΩÁ±§ÁµêÊùüËôïÁêÜÂáΩÊï∏ (Áç®Á´ãÂá∫‰æÜ)
        function finishDraw(min, max, noRepeat, t, resultEl, btn) {
            let finalResult;
            if (noRepeat) {
                do {
                    finalResult = Math.floor(Math.random() * (max - min + 1)) + min;
                } while (drawnHistory.includes(finalResult));
            } else {
                finalResult = Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            drawnHistory.push(finalResult);
            localStorage.setItem('lottery_history', JSON.stringify(drawnHistory));

            resultEl.textContent = finalResult;
            renderHistory(); 
            
            isDrawing = false;
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.textContent = t.drawAgain;

            resultEl.style.transition = "transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            resultEl.style.transform = "scale(1.2)";
            setTimeout(() => { resultEl.style.transform = "scale(1)"; }, 300);

            fireConfetti();
        }

        function fireConfetti() {
            var duration = 3000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            var random = function(min, max) { return Math.random() * (max - min) + min; }

            var interval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();
              if (timeLeft <= 0) return clearInterval(interval);
              var particleCount = 50 * (timeLeft / duration);
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
    </script>
</body>
</html>
